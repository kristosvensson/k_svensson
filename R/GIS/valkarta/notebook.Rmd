---
title: "Election map of Stockholm 2018"
author : "Kristofer Svensson"
output: 
  html_document: 
    highlight: pygments
    theme: journal
---

Trying to make a pictore of the election result from the general election 2018. 

```{r load-libraries}
# Load libraries
library(sf)
library(dplyr)
library(magrittr)
library(ggplot2)
```

SF (Simple features), is a library for GIS purposes which can handle most of the types of GIS-files that is supported in software as QGIS and ArcGIS. 

As both the election districts data and the Stockholm map is in ESRI shape file format, SF is an exellent choice for working with the files.

dplyr is a standard library for working with tidy data files and comes with the Tidyverse suite of libraries, as is also the case with ggplot2 which is the de fact standard library for making visualisations in R.

```{r reading-election-district-sf}
election_district_data <- st_read("data/2018_valgeografi_valdistrikt/alla_valdistrikt.shp") %>% st_transform(3011)
```

```{r filtering-election-district-sthlm}
election_district_data %<>%
  filter(KOM == "0180") 
plot(election_district_data$geometry)
```

```{r read-land-sf}
sthlm_land_area <- st_read("data/Stockholm_Taetortskarta_Utskrift_shp/Land_area.shp") %>% 
  st_transform(3011) %>%
  st_union() %>% 
  st_as_sf()
```

Mycket vatten. Slå ihop med valdistriktkarta för att få bort vatten.

```{r intersect-sf-1-sf-2}
election_district_no_water <- st_intersection(election_district_data, sthlm_land_area)
plot(election_district_no_water$geometry)
```

```{r read-election-data}
library(readxl) # for reading excel
library(janitor) # for cleaning data

election_data <- read_excel("data/tab5_riksdag.xlsx") %>% clean_names() %>% remove_empty()

head(election_data)
```

```{r election-data-longer, echo = "FALSE"}
library(tidyr) # library for making data 'tidy'

election_data <- election_data %>% 
  filter(valkretsnamn == "Stockholms kommun")

election_data_longer <- election_data %>%
  pivot_longer(c("m":"ovr"), names_to = "parti", values_to = "resultat")
```

```{r}
election_map_result_national <- inner_join(election_district_no_water, election_data_longer, by = c("VD_NAMN" = "valdistriktsnamn"))

head(election_map_result_national)
```

```{r}
election_data_top_national <- election_map_result_national %>%
  group_by(VD_NAMN) %>%
  slice_max(n = 1, order_by = resultat, with_ties = FALSE)

head(election_data_top_national)
```

```{r results = 'hide'}
election_data_top_national %>%
  group_by(parti) %>%
  summarise(count = n())
```
```{r}
election_data_top_national %>%
  ggplot(
    aes(
      fill = parti
    )
  ) +
  geom_sf(colour = NA) + 
  theme_void() + 
  scale_fill_manual(
    breaks = c("m", "s", "v"), labels = c("M", "S", "V"), values = c("#1b49dd", "#ed1b34", "#b00000")
  )
```
The map above shows which party was the biggest in each election district. However, it does not show which block of parties was the bigger. 
To show this we divide the parties inte the two major groups in the Swedish parliament:
```{r}
election_map_result_national %<>% 
  mutate(
    block_h_v = ifelse(parti %in% c("m", "kd", "l", "sd"), "M-KD-L-SD", "S-C-Mp-V")
  )
```
Now we plot this:
```{r}
election_map_result_national %>%
  group_by(VD_NAMN, block_h_v) %>%
  summarise(votes = sum(resultat)) %>%
  group_by(VD_NAMN) %>%
  slice_max(n = 1, order_by = votes, with_ties = FALSE) %>%
  ungroup() %>%
  ggplot(
    aes(
      fill = block_h_v
    )
  ) +
  geom_sf(colour = NA) + 
  theme_void() + 
  scale_fill_manual(
    breaks = c("M-KD-L-SD", "S-C-Mp-V"), values = c("#1b49dd", "#ed1b34")
  )
```
```{r}
election_map_result_national %>%
  group_by(parti) %>%
  summarise(votes = sum(resultat)/sum(election_map_result_national$resultat)) %>%
  ggplot(
    aes(x = parti, y = votes)
  ) +
  geom_col() +
  theme_minimal() +
  scale_y_continuous(labels = scales::label_percent())
```
It's hard to visualise this.
Dot density map can be the way to go! 
  
```{r create-number-of-dots-for-each-district}
number_dots <- as.data.frame(election_data) %>%
  select(m:sd) %>%
  mutate_all(~(round(./25)),0)
```

```{r sample-dots-for-each-district}
library(purrr)
dots <- map_df(names(number_dots),
               ~st_sample(election_district_no_water, size=number_dots[,.x], type = 'random') %>%
  st_cast("POINT") %>%
  st_coordinates() %>%
  as_tibble() %>%  
  setNames(c("x","y")) %>% 
  mutate(Parti = .x)
)
```






